# dashboard.py - Panel de Control Bio-Engine (Formato Latino)
import streamlit as st
import pandas as pd
import config
import os
import altair as alt

# Configuraci칩n de P치gina
st.set_page_config(page_title="Bio-Engine Gonzalo", layout="wide", page_icon="游빏")

# --- FUNCIONES DE CARGA ---
def load_data():
    # 1. Cargar Peso
    if os.path.exists(config.CSV_PESO_MAESTRO):
        df_peso = pd.read_csv(config.CSV_PESO_MAESTRO, sep=';')
        df_peso['Fecha'] = pd.to_datetime(df_peso['Fecha'])
    else:
        df_peso = pd.DataFrame(columns=['Fecha', 'Peso', 'Grasa_Pct', 'Masa_Muscular_Kg'])

    # 2. Cargar Deportes
    if os.path.exists(config.CSV_DEPORTE_MAESTRO):
        df_sport = pd.read_csv(config.CSV_DEPORTE_MAESTRO, sep=';')
        df_sport['Fecha'] = pd.to_datetime(df_sport['Fecha'])
    else:
        df_sport = pd.DataFrame(columns=['Fecha', 'Tipo', 'Distancia (km)', 'Duracion (min)'])
        
    return df_peso, df_sport

# --- FUNCI칍N DE FORMATO VISUAL (DD/MM/AAAA) ---
def mostrar_tabla_latina(df):
    """Convierte la fecha a DD/MM/AAAA solo para visualizaci칩n, sin romper el orden"""
    if df.empty:
        st.write("No hay datos para mostrar.")
        return

    # Creamos una copia para no romper la l칩gica de las gr치ficas
    df_visual = df.copy()
    
    # Formateamos la fecha a String d칤a/mes/a침o
    # (Ojo: Pandas usa min칰sculas para m/d/y en strftime)
    df_visual['Fecha'] = df_visual['Fecha'].dt.strftime('%d/%m/%Y')
    
    # Mostramos la tabla
    st.dataframe(df_visual, use_container_width=True)

# --- INTERFAZ ---
st.title("游빏 Bio-Engine: Panel de Control Biomec치nico")

# Carga de datos
df_peso, df_sport = load_data()

# --- SIDEBAR (Filtros) ---
st.sidebar.header("Filtros Temporales")
fecha_min = min(df_peso['Fecha'].min(), df_sport['Fecha'].min()) if not df_peso.empty else pd.to_datetime('2024-01-01')
fecha_max = pd.to_datetime('today')

start_date = st.sidebar.date_input("Desde", fecha_min)
end_date = st.sidebar.date_input("Hasta", fecha_max)

# Convertir inputs a datetime para filtrar
mask_p = (df_peso['Fecha'] >= pd.to_datetime(start_date)) & (df_peso['Fecha'] <= pd.to_datetime(end_date))
mask_s = (df_sport['Fecha'] >= pd.to_datetime(start_date)) & (df_sport['Fecha'] <= pd.to_datetime(end_date))

df_p_filtered = df_peso.loc[mask_p].sort_values('Fecha', ascending=True)
df_s_filtered = df_sport.loc[mask_s].sort_values('Fecha', ascending=True)

# --- SECCI칍N 1: AUDITOR칈A DE ESTRUCTURA CORPORAL ---
st.header("1. Auditor칤a de Estructura Corporal")

# KPIs
col1, col2, col3 = st.columns(3)
if not df_p_filtered.empty:
    ultimo = df_p_filtered.iloc[-1]
    anterior = df_p_filtered.iloc[-2] if len(df_p_filtered) > 1 else ultimo
    
    delta_peso = ultimo['Peso'] - anterior['Peso']
    
    col1.metric("Peso Actual", f"{ultimo['Peso']} kg", f"{delta_peso:.2f} kg")
    
    if pd.notnull(ultimo['Grasa_Pct']):
        col2.metric("Grasa Corporal", f"{ultimo['Grasa_Pct']}%")
    else:
        col2.metric("Grasa Corporal", "N/A")
        
    if pd.notnull(ultimo['Masa_Muscular_Kg']):
        col3.metric("Masa Muscular", f"{ultimo['Masa_Muscular_Kg']} kg")
    else:
        col3.metric("Masa Muscular", "N/A")

# Gr치ficas
tab1, tab2 = st.tabs(["Evoluci칩n de Peso", "Composici칩n (Grasa vs M칰sculo)"])

with tab1:
    # Usamos Altair para personalizar el tooltip con formato latino
    chart_peso = alt.Chart(df_p_filtered).mark_line(point=True).encode(
        x=alt.X('Fecha', axis=alt.Axis(format='%d/%m/%Y', title='Fecha')),
        y=alt.Y('Peso', scale=alt.Scale(zero=False)),
        tooltip=[alt.Tooltip('Fecha', format='%d/%m/%Y'), 'Peso', 'Fuente']
    ).interactive()
    st.altair_chart(chart_peso, use_container_width=True)

with tab2:
    # Preparamos datos para gr치fica compuesta
    if 'Grasa_Pct' in df_p_filtered.columns and df_p_filtered['Grasa_Pct'].notnull().any():
        st.line_chart(df_p_filtered.set_index('Fecha')[['Grasa_Pct', 'Masa_Muscular_Kg']])
    else:
        st.info("No hay datos suficientes de composici칩n corporal (Grasa/M칰sculo) en este rango.")

# Tabla de Datos (Formato Latino)
with st.expander("Ver Historial Detallado de Peso"):
    # Ordenamos descendente para ver lo 칰ltimo primero
    df_show = df_p_filtered.sort_values('Fecha', ascending=False)
    mostrar_tabla_latina(df_show)

st.divider()

# --- SECCI칍N 2: GESTI칍N DE ACTIVOS (Entrenamiento) ---
st.header("2. Gesti칩n de Activos (Carga de Entrenamiento)")

# KPIs Deportivos
col1, col2, col3 = st.columns(3)
if not df_s_filtered.empty:
    total_km = df_s_filtered['Distancia (km)'].sum()
    total_sesiones = len(df_s_filtered)
    # Promedio mensual (aprox)
    dias = (pd.to_datetime(end_date) - pd.to_datetime(start_date)).days
    meses = max(dias / 30, 1)
    
    col1.metric("Volumen Total", f"{total_km:.1f} km")
    col2.metric("Sesiones Totales", f"{total_sesiones}")
    col3.metric("Promedio Mensual", f"{total_km/meses:.1f} km/mes")

# Gr치ficas
st.subheader("Volumen por Deporte")
# Gr치fico de barras apiladas por tipo
chart_sport = alt.Chart(df_s_filtered).mark_bar().encode(
    x=alt.X('Fecha', axis=alt.Axis(format='%d/%m/%Y')),
    y='Distancia (km)',
    color='Tipo',
    tooltip=[alt.Tooltip('Fecha', format='%d/%m/%Y'), 'Tipo', 'Distancia (km)', 'Duracion (min)']
).interactive()
st.altair_chart(chart_sport, use_container_width=True)

# Tabla de Actividades (Formato Latino)
with st.expander("Ver Bit치cora de Entrenamiento"):
    df_show_sport = df_s_filtered.sort_values('Fecha', ascending=False)
    mostrar_tabla_latina(df_show_sport)
